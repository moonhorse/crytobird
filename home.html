<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <script type="text/javascript" src="js/nebPay.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

    <script type="text/javascript">
      var CONTRACT_ADDR = "n1eNs6JoGNKU4gcXFDYvQjY3yLJM5U8vdm4";
      var NebPay = require("nebpay");
      var nebPay = new NebPay();
      var serialNumber;
      var callbackUrl = NebPay.config.testnetUrl;
      var time_id;

      function onPlayClick() {
        var to = CONTRACT_ADDR;
        var value = '0.001';
        var callFunction = 'startToPlay';
        var callArgs = '[]';
        serialNumber = nebPay.call(to, value, callFunction, callArgs, {
          callback:callbackUrl,
          listener: onPlayClickListener
        });
        console.log(serialNumber)
        time_id = setInterval(() => {
          poll();
        }, 2000);
      }

      function onPlayClickListener(resp) {
	   console.log("on call click ");
	   setLoading(true);
      }


      function poll() {
        console.log('onrefreshClick')
        nebPay.queryPayInfo(serialNumber,{callback: callbackUrl})   //search transaction result from server (result upload to server by app)
          .then(function (resp) {
            resp = JSON.parse(resp)
            if((resp.code === 0 && resp.data.status === 1)){

	      setLoading(false);
		 
              clearInterval(time_id)
              var gameid = JSON.parse( resp.data.execute_result )
              window.location.href = 'floppybird.html?id='+gameid+'&r='+10000*Math.random()
            }
          })
          .catch(function (err) {
            console.log(err);
          });
      }

      // Set the screen to loading status
      function setLoading(state) {
	   if (state) {
		$('#cover').show()
	   } else {
		$('#cover').hide()
	   }
      }


    </script>
</head>
<body>
    <div class="page-header">
  <h1>CryptoBird</h1>
</div>

<div class="container">
    <div class="text-center">
        <img src="assets/splash.png" class="img-polaroid">
    </div>
    <div class="text-center">This is CryptoBird Home</div>
    <div class="text-center">
        <button  class="btn btn-primary btn-large"  type="button" onClick="onPlayClick();">Start Game</button>
    </div>
    <div>
	Current Balance: <span id="playerBalance"></span>
    </div>
</div>

<div style="position: absolute; left: 0px; top: 0px; width: 100%; height: 100%; background-color: black; opacity: 0.8; display: none;" id="cover">
   <div style="position: absolute; top: 100px; left: 100px; font-size: 48px; font-color: white;">
	      Loading ...
   </div>
</div>

</body>
<script>
     
      function updatePlayerInfo() {
        var to = CONTRACT_ADDR;
        var value = '0.001';
        var callFunction = 'getPlayer';
        var callArgs = '[]';
        serialNumber = nebPay.call(to, value, callFunction, callArgs, {
          callback:callbackUrl,
          listener: playerInfoCb
        });
        console.log(serialNumber)
        time_id = setInterval(() => {
          pollPlayerInfo();
        }, 2000);
      }

      function playerInfoCb(resp) {
	console.log('on player info cb')
	console.log(resp)
      }


      function pollPlayerInfo() {
        console.log('on player info')
        nebPay.queryPayInfo(serialNumber,{callback: callbackUrl})   //search transaction result from server (result upload to server by app)
          .then(function (resp) {
            resp = JSON.parse(resp)
            if((resp.code === 0 && resp.data.status === 1)){
	      console.log('on player info poll')
	      console.log(resp)
              clearInterval(time_id)
              var playerInfo = JSON.parse( resp.data.execute_result )
              $('#playerBalance').text = playerInfo.balance
              window.location.href = 'floppybird.html?id='+gameid
            }
          })
          .catch(function (err) {
            console.log(err);
          });
      }

      // Initialize the page
      updatePlayerInfo();
</script>
</html>
